<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Name Prediction and Reconciliation - Visual Flowchart</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .mermaid {
            text-align: center;
            background-color: white;
        }
        .legend {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .legend h3 {
            margin-top: 0;
            color: #333;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
        }
        .input { background-color: #2196f3; }
        .database { background-color: #4caf50; }
        .context { background-color: #ff9800; }
        .filter { background-color: #9c27b0; }
        .scoring { background-color: #f44336; }
        .calculation { background-color: #795548; }
        .dedup { background-color: #607d8b; }
        .ranking { background-color: #3f51b5; }
        .decision { background-color: #e91e63; }
        .high-conf { background-color: #4caf50; }
        .low-conf { background-color: #ff5722; }
        .output { background-color: #009688; }
        .tracking { background-color: #673ab7; }
        .final { background-color: #1976d2; }
        
        .scoring-details {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff3e0;
            border-radius: 5px;
            border-left: 4px solid #ff9800;
        }
        .scoring-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .scoring-item {
            background-color: white;
            padding: 10px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .scoring-item strong {
            color: #e65100;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Player Name Prediction and Reconciliation Process</h1>
        
        <div class="mermaid">
flowchart TD
    A["OCR Results from Cell<br/>(ROI or Whole-Cell winner)"] --> B["Extract OCR Data Fields"]
    
    B --> B1["Last Name (primary)"]
    B --> B2["First Name"]
    B --> B3["Team Abbreviation"]
    B --> B4["Bye Week Number"]
    B --> B5["OCR Position Text"]
    B --> B6["Color-Based Position"]
    
    B1 --> C["Load Player Database<br/>(top500_playernames.csv)"]
    B2 --> C
    B3 --> C
    B4 --> C
    B5 --> C
    B6 --> C
    
    C --> D["Calculate Draft Context"]
    D --> D1["Convert grid position to draft pick<br/>(Snake draft logic: row, col → pick #)"]
    D1 --> D2["Determine expected player rank<br/>based on draft position"]
    
    D2 --> E["Apply Position Filters"]
    E --> E1{"Color position<br/>available?"}
    E1 -->|Yes| E2["Filter candidates by position<br/>(QB, RB, WR, TE, K, DST)"]
    E1 -->|No| E3["Use all players as candidates"]
    E2 --> F["Multi-Factor Scoring System"]
    E3 --> F
    
    F --> F1["Score Component 1: Last Name<br/>Fuzzy string matching (0-40 pts)"]
    F --> F2["Score Component 2: First Name<br/>Fuzzy string matching (0-15 pts)"]
    F --> F3["Score Component 3: Team Match<br/>Exact team abbreviation (0-15 pts)"]
    F --> F4["Score Component 4: Bye Week<br/>Exact bye week number (0-10 pts)"]
    F --> F5["Score Component 5: Color Position<br/>Position from color analysis (0-15 pts)"]
    F --> F6["Score Component 6: OCR Position<br/>Position from OCR text (0-10 pts)"]
    F --> F7["Score Component 7: Draft Likelihood<br/>Gaussian probability model (0-20 pts)"]
    
    F1 --> G["Calculate Total Score<br/>(Maximum: 125 points)"]
    F2 --> G
    F3 --> G
    F4 --> G
    F5 --> G
    F6 --> G
    F7 --> G
    
    G --> H["Filter Used Players<br/>(Prevent duplicates)"]
    H --> H1["Check player identity against<br/>used_players set"]
    H1 --> H2["Skip already drafted players"]
    
    H2 --> I["Rank All Candidates<br/>(Sort by total score)"]
    I --> I1["Select highest scoring candidate"]
    I1 --> I2["Get detailed score breakdown"]
    
    I2 --> J["Confidence Threshold Check"]
    J --> J1{"Score ≥ 45.0<br/>(confidence threshold)?"}
    
    J1 -->|Yes| K1["HIGH CONFIDENCE MATCH"]
    J1 -->|No| K2["LOW CONFIDENCE - USE OCR"]
    
    K1 --> K1a["Use database player data"]
    K1a --> K1b["Full name from CSV"]
    K1a --> K1c["Team from CSV"]
    K1a --> K1d["Position from CSV"]
    K1a --> K1e["Bye week from CSV"]
    K1a --> K1f["Mark as 'csv' source"]
    
    K2 --> K2a["Use raw OCR data"]
    K2a --> K2b["Combine OCR first + last"]
    K2a --> K2c["Use OCR team (if available)"]
    K2a --> K2d["Use color position or OCR position"]
    K2a --> K2e["Use OCR bye week"]
    K2a --> K2f["Mark as 'ocr' source"]
    
    K1f --> L["Final Player Result"]
    K2f --> L
    
    L --> L1["Player identity with confidence"]
    L --> L2["Source attribution (csv/ocr)"]
    L --> L3["Match score and breakdown"]
    L --> L4["Draft position analysis"]
    L --> L5["Raw OCR data preserved"]
    
    L5 --> M["Add to used_players set<br/>(Prevent future duplicates)"]
    M --> N["Return Complete Player Record"]
    
    style A fill:#2196f3,color:#fff
    style C fill:#4caf50,color:#fff
    style D fill:#ff9800,color:#fff
    style E fill:#9c27b0,color:#fff
    style F fill:#f44336,color:#fff
    style G fill:#795548,color:#fff
    style H fill:#607d8b,color:#fff
    style I fill:#3f51b5,color:#fff
    style J fill:#e91e63,color:#fff
    style K1 fill:#4caf50,color:#fff
    style K2 fill:#ff5722,color:#fff
    style L fill:#009688,color:#fff
    style M fill:#673ab7,color:#fff
    style N fill:#1976d2,color:#fff
        </div>

        <div class="legend">
            <h3>Process Stages Legend</h3>
            <div class="legend-item">
                <div class="legend-color input"></div>
                <strong>OCR Input:</strong> Winning OCR results from dual-strategy pipeline
            </div>
            <div class="legend-item">
                <div class="legend-color database"></div>
                <strong>Database Integration:</strong> Load and process player database with rankings
            </div>
            <div class="legend-item">
                <div class="legend-color context"></div>
                <strong>Draft Context:</strong> Calculate draft position and expected player rank
            </div>
            <div class="legend-item">
                <div class="legend-color filter"></div>
                <strong>Position Filtering:</strong> Use color-based position to narrow candidates
            </div>
            <div class="legend-item">
                <div class="legend-color scoring"></div>
                <strong>Multi-Factor Scoring:</strong> 7-component scoring system (125 max points)
            </div>
            <div class="legend-item">
                <div class="legend-color calculation"></div>
                <strong>Score Calculation:</strong> Combine all scoring components
            </div>
            <div class="legend-item">
                <div class="legend-color dedup"></div>
                <strong>Duplicate Prevention:</strong> Filter out already-used players
            </div>
            <div class="legend-item">
                <div class="legend-color ranking"></div>
                <strong>Candidate Ranking:</strong> Sort and select best match
            </div>
            <div class="legend-item">
                <div class="legend-color decision"></div>
                <strong>Confidence Decision:</strong> Choose database vs OCR data based on score
            </div>
            <div class="legend-item">
                <div class="legend-color high-conf"></div>
                <strong>High Confidence:</strong> Use verified database player data (≥45 points)
            </div>
            <div class="legend-item">
                <div class="legend-color low-conf"></div>
                <strong>Low Confidence:</strong> Fall back to raw OCR data (<45 points)
            </div>
            <div class="legend-item">
                <div class="legend-color output"></div>
                <strong>Final Result:</strong> Complete player record with metadata
            </div>
            <div class="legend-item">
                <div class="legend-color tracking"></div>
                <strong>Usage Tracking:</strong> Add to used players set
            </div>
            <div class="legend-item">
                <div class="legend-color final"></div>
                <strong>Complete Record:</strong> Return final player data
            </div>
        </div>

        <div class="scoring-details">
            <h3 style="margin-top: 0; color: #e65100;">Multi-Factor Scoring System (125 Points Maximum)</h3>
            <div class="scoring-grid">
                <div class="scoring-item">
                    <strong>Last Name (40 pts)</strong><br/>
                    Fuzzy string matching using token_set_ratio<br/>
                    Handles OCR errors and name variations
                </div>
                <div class="scoring-item">
                    <strong>First Name (15 pts)</strong><br/>
                    Additional fuzzy matching when available<br/>
                    Provides extra validation
                </div>
                <div class="scoring-item">
                    <strong>Team Match (15 pts)</strong><br/>
                    Exact team abbreviation matching<br/>
                    High confidence when teams align
                </div>
                <div class="scoring-item">
                    <strong>Bye Week (10 pts)</strong><br/>
                    Exact bye week number matching<br/>
                    Additional validation factor
                </div>
                <div class="scoring-item">
                    <strong>Color Position (15 pts)</strong><br/>
                    Position from color analysis<br/>
                    Strong positional validation
                </div>
                <div class="scoring-item">
                    <strong>OCR Position (10 pts)</strong><br/>
                    Position from OCR text recognition<br/>
                    Secondary positional validation
                </div>
                <div class="scoring-item" style="grid-column: span 2;">
                    <strong>Draft Likelihood (20 pts)</strong><br/>
                    Gaussian probability model based on Average Draft Position (ADP)<br/>
                    Considers draft position context and player rankings<br/>
                    Sigma grows with rank to reflect real draft variance
                </div>
            </div>
        </div>

        <div style="margin-top: 30px; padding: 15px; background-color: #e8f5e9; border-radius: 5px;">
            <h3 style="margin-top: 0; color: #2e7d32;">Key Intelligence Features:</h3>
            <ul>
                <li><strong>Fuzzy Matching:</strong> Handles OCR errors using Levenshtein distance algorithms</li>
                <li><strong>Draft Context:</strong> Uses snake draft logic and ADP rankings for realistic predictions</li>
                <li><strong>Multi-Modal Validation:</strong> Combines text, color, positional, and statistical data</li>
                <li><strong>Confidence Thresholding:</strong> 45-point threshold ensures data quality</li>
                <li><strong>Graceful Degradation:</strong> Falls back to OCR when database matching fails</li>
                <li><strong>Duplicate Prevention:</strong> Sophisticated identity tracking prevents double-drafting</li>
                <li><strong>Transparency:</strong> Detailed score breakdown enables debugging and validation</li>
                <li><strong>Source Attribution:</strong> Tracks whether data came from database or OCR</li>
            </ul>
        </div>

        <div style="margin-top: 20px; padding: 15px; background-color: #f3e5f5; border-radius: 5px;">
            <h3 style="margin-top: 0; color: #7b1fa2;">Draft Likelihood Model:</h3>
            <p>The system uses a sophisticated Gaussian probability model:</p>
            <ul>
                <li><strong>Variable Sigma:</strong> σ = 2.0 + 0.1 × player_rank (uncertainty grows with rank)</li>
                <li><strong>Z-Score Calculation:</strong> z = (draft_pick - player_rank) / σ</li>
                <li><strong>Probability Score:</strong> 100 × e^(-0.5 × z²)</li>
                <li><strong>Real Draft Variance:</strong> Early picks are more predictable than late picks</li>
                <li><strong>Context Awareness:</strong> Considers both player ADP and actual draft position</li>
            </ul>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>
