<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Detection Process - Visual Flowchart</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .mermaid {
            text-align: center;
            background-color: white;
        }
        .legend {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .legend h3 {
            margin-top: 0;
            color: #333;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
        }
        .manual { background-color: #1976d2; }
        .auto { background-color: #7b1fa2; }
        .tier1 { background-color: #388e3c; }
        .tier2 { background-color: #f57c00; }
        .final { background-color: #2e7d32; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Color Detection Process</h1>
        
        <div class="mermaid">
flowchart TD
    A["User uploads draft board image"] --> B["User crops the board"]
    B --> C["User chooses color detection method"]
    
    C --> D["Manual Color Selection<br/>'Pick Color' buttons"]
    C --> E["Auto-Generate Colors<br/>'Detect Colors Automatically'"]
    
    D --> D1["User clicks 'Pick Color' for position<br/>(QB, RB, WR, TE, K, DST)"]
    D1 --> D2["User clicks specific pixel on image"]
    D2 --> D3["System samples exact RGB/HSV<br/>from that pixel"]
    D3 --> D4["Color stored as profile<br/>for that position"]
    D4 --> D5{"All 6 positions<br/>selected?"}
    D5 -->|No| D1
    D5 -->|Yes| F["Proceed to board processing"]
    
    E --> E1["Tier 1: Smart OCR-based Detection"]
    E1 --> E2["System performs OCR on all cells<br/>to find position text + player names"]
    E2 --> E3["For each recognized position<br/>(QB, RB, etc.), collect HSV samples<br/>from cells containing that position"]
    E3 --> E4["Calculate HSV color ranges<br/>using percentiles and padding"]
    E4 --> E5{"Successfully detected<br/>≥ 3 positions?"}
    
    E5 -->|Yes| E6["Use OCR-derived color profiles<br/>(High confidence: 1.0)"]
    E6 --> F
    
    E5 -->|No| E7["Tier 2: K-means Clustering Fallback"]
    E7 --> E8["Apply K-means clustering<br/>with 6 clusters to entire image"]
    E8 --> E9["Filter pixels by saturation/value<br/>(Remove background/white pixels)"]
    E9 --> E10["Sort clusters by size<br/>(largest to smallest)"]
    E10 --> E11["Assign clusters to positions<br/>in order: WR→RB→QB→TE→DST→K"]
    E11 --> E12["Generate color profiles<br/>(Lower confidence: 0.5)"]
    E12 --> F
    
    F --> G["User can refine colors manually<br/>or proceed to processing"]
    G --> H["System processes entire board<br/>using established color profiles"]
    
    style D fill:#1976d2,color:#fff
    style E fill:#7b1fa2,color:#fff
    style E1 fill:#388e3c,color:#fff
    style E7 fill:#f57c00,color:#fff
    style F fill:#2e7d32,color:#fff
        </div>

        <div class="legend">
            <h3>Color Detection Methods</h3>
            <div class="legend-item">
                <div class="legend-color manual"></div>
                <strong>Manual Color Selection:</strong> User directly clicks pixels to select colors for each position
            </div>
            <div class="legend-item">
                <div class="legend-color auto"></div>
                <strong>Auto-Generate Colors:</strong> Intelligent two-tier system for automatic color detection
            </div>
            <div class="legend-item">
                <div class="legend-color tier1"></div>
                <strong>Tier 1 - Smart OCR Detection:</strong> Uses actual draft board content (preferred method)
            </div>
            <div class="legend-item">
                <div class="legend-color tier2"></div>
                <strong>Tier 2 - K-means Fallback:</strong> Clustering-based detection when OCR fails
            </div>
            <div class="legend-item">
                <div class="legend-color final"></div>
                <strong>Final Processing:</strong> Board processing using established color profiles
            </div>
        </div>

        <div style="margin-top: 30px; padding: 15px; background-color: #e8f5e9; border-radius: 5px;">
            <h3 style="margin-top: 0; color: #2e7d32;">Two-Tier Intelligence:</h3>
            <ul>
                <li><strong>Smart First:</strong> OCR-based detection reads actual position text and player names</li>
                <li><strong>Fallback Safety:</strong> K-means clustering ensures system always works</li>
                <li><strong>Confidence Scoring:</strong> High confidence (1.0) for OCR, lower (0.5) for K-means</li>
                <li><strong>User Control:</strong> Manual refinement always available</li>
                <li><strong>Graceful Degradation:</strong> System adapts to image quality and layout variations</li>
            </ul>
        </div>

        <div style="margin-top: 20px; padding: 15px; background-color: #fff3e0; border-radius: 5px;">
            <h3 style="margin-top: 0; color: #ef6c00;">K-means Clustering Details:</h3>
            <p>When Tier 2 activates, the system:</p>
            <ul>
                <li>Filters out background/white pixels (saturation ≥40, value ≥60)</li>
                <li>Performs K-means clustering with 6 clusters</li>
                <li>Sorts clusters by pixel count (largest first)</li>
                <li>Assigns to positions in priority order: WR → RB → QB → TE → DST → K</li>
                <li>This is where your <strong>K-means visualization plots</strong> are most relevant!</li>
            </ul>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>
